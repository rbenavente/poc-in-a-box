node {

//def APOCTL_NAMESPACE ='/807152304871829504/cto-demo-rbc/demo-build'
//def APOCTL_CREDS = credentials('pipeline.cred')
def TENANT='807152304871829504'
def CLOUD='cto-demo-rbc'
def GROUP='demo-build'
def APOCTL_API="https://api.east-02.network.prismacloud.io"


stage('Clone repository') {
checkout scm
}

stage('Download apoctl') {
sh "curl -o /usr/local/bin/apoctl https://download.aporeto.com/apoctl/linux/apoctl"
sh "sudo chmod +x /usr/local/bin/apoctl"
}

stage('Check if the authorization works') {
withCredentials([file(credentialsId: 'pipeline.creds', variable: 'APOCTL_CREDS')]){
 sh "apoctl auth verify"
}

}
stage('Deploy app and Policy as Code') {
withEnv (["TENANT=${TENANT}","CLOUD=${CLOUD}","GROUP=${GROUP}", "APOCTL_API=${APOCTL_API}"]) {

sh "pwd"
sh "ls -la"
sh "echo $TENANT"
sh "echo $GROUP"
sh "echo $CLOUD"
sh "all/create"

}

}
}
